---
title: "StormDataAnalysis"
author: "Heli Pykälä"
date: "2016-04-28"
output: html_document
---

Libraries
```{r}
library(R.utils)
library(data.table)
library(ggplot2)

```


Data download and unzipping for reference
```{r download}
#dir.create("data")
#download.file("https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2", 
#              destfile = "data/StormData.csv.bz2", mode = "wb")
#bunzip2("data/StormData.csv.bz2")
```

Read data and select only interesting columns for the analyisis. Empty string is null.
```{r readData, cache=TRUE}
storm <- fread("data/StormData.csv")
str(storm)
```

Convert begin date to date
```{r preprocess1}
storm[,BGN_DATE:=as.Date(BGN_DATE, format = "%m/%d/%Y") ]
```

Convert property damage and crop damage to comparable dollar amounts by multiplying the amount by the exponent. For exponent we use “K” for thousands, “M” for millions, and “B” for billions as documented.
```{r preprocess2, cache=FALSE}
convertDamage <- function(dmgexp,dmg) {
    mult <- switch(toupper(dmgexp),
           "K" = 1E3,
           "M" = 1E6,
           "B" = 1E9,
           "1" = 1E1,
           "2" = 1E2,
           "3" = 1E3,
           "4" = 1E4,
           "5" = 1E5,
           "6" = 1E6,
           "7" = 1E7,
           "8" = 1E8,
           1)
    mult*dmg
}

storm[,CDMG:=mapply(convertDamage,.SD[,CROPDMGEXP],.SD[,CROPDMG])]
storm[,PDMG:=mapply(convertDamage,.SD[,PROPDMGEXP],.SD[,PROPDMG])]
    
```



```{r}
head(storm[order(PDMG,decreasing = TRUE),c("REFNUM","BGN_DATE", "STATE", "EVTYPE","PROPDMG","PROPDMGEXP", "PDMG"),with=FALSE])

```

The maximum property damage is a magnitude larger than the following ones. This is related to a flood of Napa river in 2005. The following three seem to be related to hurricane Katrina and it's not feasible that a flood would cause a magnitude order bigger damages.

```{r}
storm[REFNUM==605943,REMARKS]
```

According to the event description it seems that property damage magnitude should be millions instead of billions. In any case this data point would dominate the whole analysis and we have to either fix or remove it. For the further analysis, change the PROPDMGEXP to "M" and recalcucate property damages.
```{r, cache=FALSE}
storm[REFNUM==605943,PROPDMGEXP:="M"]
storm[,PDMG:=mapply(convertDamage,.SD[,PROPDMGEXP],.SD[,PROPDMG])]
```

```{r}
head(storm[order(CDMG,decreasing = TRUE),c("REFNUM","BGN_DATE", "STATE", "EVTYPE","CROPDMG","CROPDMGEXP", "CDMG"),with=FALSE])
head(storm[order(INJURIES,decreasing = TRUE),c("REFNUM","BGN_DATE", "STATE", "EVTYPE","INJURIES","FATALITIES"),with=FALSE])
head(storm[order(FATALITIES,decreasing = TRUE),c("REFNUM","BGN_DATE", "STATE", "EVTYPE","INJURIES","FATALITIES"),with=FALSE])

```

In other damage categories there don't seem to be such glaring errors. In this kind of case finding outliers is difficult as it's expected that vast majority of events cause no significant damages, but then there are rare cases like hurricane Katrina, which cause enormous damages. So outier removal or fixing must be done case by case. 

In addition to outliers we can see a further problem, which will complicate the analysis. The EVTYPE variable has almost 1000 individual variables, many of which should be combined. We fix a few most obvious ones, but this would require further research.


```{r}
#TSTM is abbreviation for thunderstorm
storm[,EVTYPE:=gsub("TSTM", "THUNDERSTORM",EVTYPE)]
#a few hurricanes were named, so use hurricane for everything and also for typhoons
storm[,EVTYPE:=gsub(".*HURRICANE.*", "HURRICANE",EVTYPE)]
storm[,EVTYPE:=gsub(".*TYPHOON.*", "HURRICANE", EVTYPE)]
storm[,EVTYPE:=gsub("RIP CURRENTS", "RIP CURRENT", EVTYPE)]
```

Next we aggregate the data by evtype and year

```{r}
sum <- storm[,j=list(INJURIES=sum(INJURIES), FATALITIES=sum(FATALITIES), PDMG = sum(PDMG), CDMG= sum(CDMG)), by=list(EVTYPE,YEAR=year(BGN_DATE))]
```


Then see how the number of recorded event types has changed over years.
```{r}
nevtype <- sum[,j=list(EVTYPE=length(unique(EVTYPE))),by=YEAR]
nevtype
```

We see that until 1992 only few event types were recorded. Then the number of event types exploded and there are way too many unique event types. After the start of 2000 the number of evtypes has stabilized. To get reliable results we limit the scope of analysis to years later than 2000. Calculate the yearly averages by event type after 2000.


```{r}
yearly2000 <- sum[YEAR > 2000,j=list(INJURIES=mean(INJURIES), FATALITIES=mean(FATALITIES), PDMG = mean(PDMG), CDMG= mean(CDMG)),by=EVTYPE]

```



## Weather events by harm done to the population

Melt the data and pick the 10 most harmful events for both fatalities and injuries. Create new data table for fatalities and injuries by those events and recalculate the levels in order by number of injuries or deaths. As the magnitude of injuries is larger, this means ordering the factors by number of injuries in practice.

```{r}
popharm <- melt(yearly2000,"EVTYPE",c("INJURIES","FATALITIES"))

popharmevs <- unique(popharm[,head(.SD[order(-value)],10),by=variable]$EVTYPE)
toppopharm <- popharm[EVTYPE %in% popharmevs,]
toppopharm$EVTYPE <- factor(toppopharm$EVTYPE, levels=unique(toppopharm$EVTYPE[order(-toppopharm$value)]))
```


Plot the injuries and fatalities by event type. Notice that the y axis are different and there are much more injuries than fatalities.
```{r}
ggplot(toppopharm, aes(x = EVTYPE,y=value)) + 
    geom_bar(stat = "identity") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1,vjust=.5))+
    facet_grid(variable~.,scales = "free_y")
```

From the plot we can see that tornado is the most harmful weather event causing about 1300 injuries and 100 deaths per year. The second most harmful event by both deaths and injuries is excessive heat killing about 80 and injuring 300 people per year. The third by injuries are thunderstorm winds but by fatalities it is outrun by lightnings, flash floods and floods.

## Weather events by economic damage

```{r}
yearly2000[,TOTDMG := PDMG+CDMG]

econharm <- melt(yearly2000, "EVTYPE", c("PDMG", "CDMG", "TOTDMG"))
econharmevs <- unique(econharm[,head(.SD[order(-value)],10),by=variable]$EVTYPE)
topeconharm <- econharm[EVTYPE %in% econharmevs,]
topeconharm$EVTYPE <- factor(topeconharm$EVTYPE, levels=unique(topeconharm$EVTYPE[order(-topeconharm$value)]))

ggplot(topeconharm[variable %in% c("CDMG","PDMG")], aes(x = EVTYPE,y=value,fill=variable)) + 
    geom_bar(stat = "identity") +
    theme(axis.text.x = element_text(angle = 90, hjust = 1,vjust=.5))
```